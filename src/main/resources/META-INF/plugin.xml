<!-- Plugin Configuration File. Read more: https://plugins.jetbrains.com/docs/intellij/plugin-configuration-file.html -->
<idea-plugin>
    <idea-version since-build="251" />
    <!-- Unique identifier of the plugin. It should be FQN. It cannot be changed between the plugin versions. -->
    <id>paol0b.AzureDevOps</id>
    <version>2.0</version>

    <!-- Public plugin name should be written in Title Case.
         Guidelines: https://plugins.jetbrains.com/docs/marketplace/best-practices-for-listing.html#plugin-name -->
    <name>Azure DevOps Integration</name>

    <!-- A displayed Vendor name or Organization ID displayed on the Plugins Page. -->
    <vendor url="https://github.com/paol0b">Paolo Bertinetti</vendor>

    <!-- Description of the plugin displayed on the Plugin Page and IDE Plugin Manager.
         Guidelines: https://plugins.jetbrains.com/docs/marketplace/best-practices-for-listing.html#plugin-description -->
    <description><![CDATA[
        <h2>Azure DevOps Integration for JetBrains IDEs</h2>
        <p>Seamlessly integrate Azure DevOps into your JetBrains IDE with powerful tool windows, OAuth 2.0 authentication, and intelligent PR management - inspired by Visual Studio.</p>

        <h3>‚ú® Key Features:</h3>
        
        <h4>üîê Authentication & Accounts</h4>
        <ul>
            <li><b>OAuth 2.0 Authentication:</b> Secure Microsoft Device Code Flow authentication</li>
            <li><b>Centralized Account Management:</b> Add multiple Azure DevOps organizations in Settings ‚Üí Tools ‚Üí Azure DevOps Accounts</li>
            <li><b>Automatic Token Refresh:</b> Tokens refresh automatically when expired - no manual intervention needed</li>
            <li><b>Auto-Matching:</b> Plugin automatically matches your repository to the correct OAuth account</li>
            <li><b>Secure Storage:</b> All credentials encrypted in IDE's PasswordSafe</li>
        </ul>

        <h4>üìã Azure DevOps PRs Tool Window</h4>
        <ul>
            <li><b>Modern PR List:</b> View all Pull Requests with status badges (Active, Completed, Abandoned, All)</li>
            <li><b>Lazy Loading:</b> PRs load automatically when you open the tab - instant IDE startup</li>
            <li><b>Auto-Polling:</b> Automatic refresh in background to keep PR list up-to-date</li>
            <li><b>Detailed View:</b> See title, description, author, reviewers, branches, and status at a glance</li>
            <li><b>Create PRs:</b> Create new Pull Requests directly from the IDE with branch autocomplete</li>
            <li><b>Reviewer Management:</b> Add required and optional reviewers with search</li>
            <li><b>Diff Viewer:</b> View file changes with [A]dded, [M]odified, [D]eleted indicators</li>
            <li><b>Commits Tab:</b> See all commits included in the PR</li>
            <li><b>Quick Actions:</b> Open PRs in browser, refresh list, create new PRs with one click</li>
        </ul>

        <h4>üí¨ PR Comments Tool Window</h4>
        <ul>
            <li><b>Modern Card UI:</b> Beautiful card-based interface with clear visual hierarchy</li>
            <li><b>Lazy Loading:</b> Comments load automatically when you open the tab</li>
            <li><b>Smart Search:</b> Filter comments by file name, author, or content in real-time</li>
            <li><b>Advanced Filters:</b> Show All, Active, Resolved, or General comments with one click</li>
            <li><b>Auto-Show Comments:</b> Enable checkbox to automatically display comments when opening files</li>
            <li><b>Intelligent Auto-Refresh:</b> Updates every 30 seconds but only re-renders if there are actual changes</li>
            <li><b>One-Click Navigation:</b> Click any comment to jump directly to the file and line</li>
            <li><b>Comment Threads:</b> Press Enter to open full thread dialog with reply functionality</li>
            <li><b>Visual Indicators:</b> Icons show comment status (active, resolved, general)</li>
        </ul>

        <h4>üé® Editor & File Tree Integration</h4>
        <ul>
            <li><b>Gutter Icons:</b> Comments appear as icons in the editor gutter</li>
            <li><b>File Tree Badges:</b> See comment counts on files and folders</li>
            <li><b>Color-Coded:</b> Orange badges for active comments, green for resolved</li>
            <li><b>Rich Tooltips:</b> Hover over badges to see detailed comment breakdown</li>
            <li><b>Inline Viewing:</b> Click gutter icons to view and reply to comment threads</li>
            <li><b>C# & Rider Support:</b> Full support for all project types including .NET solutions</li>
        </ul>

        <h4>‚ö° Performance & User Experience</h4>
        <ul>
            <li><b>Lazy Loading:</b> Tool windows load content only when opened - zero startup impact</li>
            <li><b>Smart Refresh:</b> Intelligent change detection minimizes unnecessary updates</li>
            <li><b>Theme-Aware UI:</b> Perfect contrast and colors in both light and dark themes</li>
            <li><b>Automatic Detection:</b> Organization, project, and repository auto-detected from Git remote</li>
            <li><b>Multi-Organization:</b> Seamlessly work with multiple Azure DevOps organizations</li>
            <li><b>Background Operations:</b> All API calls run in background threads - no UI freezing</li>
        </ul>

        <h3>üìã Requirements:</h3>
        <ul>
            <li>IntelliJ IDEA 2024.1 or newer (all JetBrains IDEs supported)</li>
            <li>Git repository connected to Azure DevOps</li>
            <li>Microsoft account with access to your Azure DevOps organization</li>
        </ul>

        <h3>üöÄ Quick Start:</h3>
        <ol>
            <li>Install the plugin and restart the IDE</li>
            <li>Go to <b>Settings ‚Üí Tools ‚Üí Azure DevOps Accounts</b></li>
            <li>Click <b>Add</b> and sign in with your Microsoft account via browser (OAuth 2.0)</li>
            <li>Open your Azure DevOps repository in the IDE</li>
            <li>Open the <b>Azure DevOps PRs</b> or <b>PR Comments</b> tool window on the right sidebar</li>
            <li>Start managing Pull Requests and comments!</li>
        </ol>

        <h3>üí° How It Works:</h3>
        <p>The plugin uses OAuth 2.0 Device Code Flow for secure authentication. Once authenticated, your account is stored globally and automatically matched to repositories based on organization URL. The plugin detects your repository information from Git remotes - no manual configuration needed!</p>
        
        <p>When you open a tool window, it loads data automatically. Enable "Auto-show comments" in the PR Comments tab to see comments on files as you open them. Both tool windows refresh intelligently to keep data up-to-date without impacting performance.</p>

        <h3>üìö Documentation:</h3>
        <ul>
            <li><a href="https://github.com/paol0b/AzureDevOps/blob/main/GETTING_STARTED.md">Getting Started Guide</a></li>
            <li><a href="https://github.com/paol0b/AzureDevOps/blob/main/docs/OAUTH_SETUP.md">OAuth Setup Instructions</a></li>
            <li><a href="https://github.com/paol0b/AzureDevOps/blob/main/docs/USAGE_EXAMPLES.md">Usage Examples</a></li>
        </ul>

        <h3>üÜò Support:</h3>
        <p>Issues, questions, or feature requests? Visit the <a href="https://github.com/paol0b/AzureDevOps">GitHub repository</a>.</p>
    ]]></description>

    <!-- Product and plugin compatibility requirements.
         Read more: https://plugins.jetbrains.com/docs/intellij/plugin-compatibility.html -->
    <depends>com.intellij.modules.platform</depends>
    <depends>com.intellij.modules.vcs</depends>
    <depends>Git4Idea</depends>

    <!-- Extension points defined by the plugin.
         Read more: https://plugins.jetbrains.com/docs/intellij/plugin-extension-points.html -->
    <extensions defaultExtensionNs="com.intellij">
        <!-- Azure DevOps Checkout Provider for Clone Repository dialog -->
        <checkoutProvider implementation="paol0b.azuredevops.checkout.AzureDevOpsCheckoutProvider"/>
        <!-- Application-level service for account management -->
        <applicationService serviceImplementation="paol0b.azuredevops.checkout.AzureDevOpsAccountManager"/>
        <!-- OAuth authentication service -->
        <applicationService serviceImplementation="paol0b.azuredevops.checkout.AzureDevOpsOAuthService"/>
        
        <!-- Application-level configuration for accounts -->
        <applicationConfigurable 
            parentId="tools" 
            instance="paol0b.azuredevops.ui.AzureDevOpsAccountsConfigurable"
            id="paol0b.azuredevops.accounts"
            displayName="Azure DevOps Accounts"/>
            
        <!-- Project-level configuration -->
        <!--
        <projectConfigurable
            parentId="tools"
            instance="paol0b.azuredevops.ui.AzureDevOpsProjectConfigurable"
            id="paol0b.azuredevops.project"
            displayName="Azure DevOps"/>
        -->

        <!-- Notification Group -->
        <notificationGroup
                id="AzureDevOps.Notifications"
                displayType="BALLOON"
                key="notification.group.azure.devops"/>

        <!-- Tool Window -->
        <toolWindow
                id="Azure DevOps PRs"
                anchor="right"
                icon="paol0b.azuredevops.AzureDevOpsIcons.ToolWindow"
                factoryClass="paol0b.azuredevops.toolwindow.PullRequestToolWindowFactory"
                canCloseContents="false"
                doNotActivateOnStart="false"/>

        <!-- Comments Navigator Tool Window -->
        <toolWindow
                id="PR Comments"
                anchor="right"
                icon="AllIcons.Toolwindows.ToolWindowMessages"
                factoryClass="paol0b.azuredevops.toolwindow.CommentsNavigatorToolWindow"/>

        <!-- File Decorator for PR Comments -->
        <projectViewNodeDecorator implementation="paol0b.azuredevops.decorators.FileWithCommentsDecorator"/>

        <!-- File Editor Listener for PR detection -->
        <projectService serviceImplementation="paol0b.azuredevops.listeners.FileOpenedListener"/>
    </extensions>

    <projectListeners>
        <listener
                class="paol0b.azuredevops.listeners.FileOpenedListener"
                topic="com.intellij.openapi.fileEditor.FileEditorManagerListener"/>
        <listener
                class="paol0b.azuredevops.listeners.GitRepositoryChangeListener"
                topic="com.intellij.openapi.vcs.BranchChangeListener"/>
    </projectListeners>

    <actions>
        <!-- Azure DevOps Group in Git Menu -->
        <group id="AzureDevOps.Group"
               text="Azure DevOps"
               icon="paol0b.azuredevops.AzureDevOpsIcons.ToolWindow"
               popup="true">
            <!-- Place this group immediately after the GitHub menu entry -->
            <add-to-group group-id="VcsGroups" anchor="after" relative-to-action="GitHub"/>

            <action
                    id="AzureDevOps.CreatePullRequest"
                    class="paol0b.azuredevops.actions.CreatePullRequestAction"
                    text="Create Pull Request..."
                    description="Create a Pull Request on Azure DevOps"
                    icon="paol0b.azuredevops.AzureDevOpsIcons.ToolWindow"/>

            <action
                    id="AzureDevOps.OpenInBrowser"
                    class="paol0b.azuredevops.actions.OpenRepositoryInBrowserAction"
                    text="Open in Browser"
                    description="Open the repository in Azure DevOps web portal"
                    icon="AllIcons.Ide.External_link_arrow"/>
        </group>

        <!-- Add to VCS menu (legacy) -->
        <action
                id="AzureDevOps.CreatePullRequest.Legacy"
                class="paol0b.azuredevops.actions.CreatePullRequestAction"
                text="Create Azure DevOps PR"
                description="Create a Pull Request on Azure DevOps"
                icon="paol0b.azuredevops.AzureDevOpsIcons.ToolWindow">
            <add-to-group group-id="Vcs.MainMenu" anchor="last"/>
        </action>

        <!-- Show PR Comments in Editor (legacy action) -->
        <action
                id="AzureDevOps.ShowPRComments"
                class="paol0b.azuredevops.actions.ShowPullRequestCommentsAction"
                text="Show PR Comments"
                description="Show Pull Request comments in the current file"
                icon="AllIcons.Vcs.CommitNode">
            <add-to-group group-id="EditorPopupMenu" anchor="last"/>
            <add-to-group group-id="Vcs.MainMenu" anchor="last"/>
        </action>
    </actions>
</idea-plugin>